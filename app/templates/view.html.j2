{%- if points is defined -%}
{%- set total_points = points|length -%}
{%- else -%}
{%- set total_points = 0 -%}
{%- set points = None -%}
{%- endif -%}
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="robots" content="noimageindex, nofollow, nosnippet" />
        <title>Eric's Seizures ({{ total_points }} seizure{% if total_points is defined and total_points != 1 %}s{% endif %})</title>
        <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key={{ googlemaps_api_key }}"></script>
        <script type="text/javascript">

            var markers = [];
            markers.push('');
            var infowindows = [];

            function initMap() {

                const home = { lat: {{ start['latitude'] }}, lng: {{ start['longitude'] }} };
                const map = new google.maps.Map(document.getElementById('map_canvas'), {
                    zoom: {{ start['zoom'] }},
                    center: home,
                });

                {% for point in points %}
                {% set outer_loop = loop %}
                var contentString_{{ loop.index }} = '<table>';
                contentString_{{ loop.index }} += '<tr><th><a href="#{{ loop.index }}">{{ loop.index }} of {{ total_points }}</a></th><th><a href="{{ url_for('view', when=point['time']) }}">{{ point['time'] | format_datetime }}</a></th></tr>';
                {% for i in point.keys() -%}
                contentString_{{ outer_loop.index }} += '<tr><td>{{ i }}</td><td>{{ point[i] | safe | replace("'", "\\'") }}</td></tr>';
                {% endfor -%}
                contentString_{{ loop.index }} += '</table>';
                const infowindow_{{ loop.index }} = new google.maps.InfoWindow({
                    content: contentString_{{ loop.index }},
                });
                const position_{{ loop.index }} = { lat: {{ point['latitude'] }}, lng: {{ point['longitude'] }} };
                const marker_{{ loop.index }} = new google.maps.Marker({
                    position: position_{{ loop.index }},
                    map,
                    title: "{{ point['time'] | format_datetime }}",
                });
                marker_{{ loop.index }}.addListener('click', () => {
                    if (infowindows) {
                        for (const [key, value] of Object.entries(infowindows)) {
                            infowindows[key].close();
                            delete(infowindows[key]);
                        };
                    };
                    infowindow_{{ loop.index }}.open({
                        anchor: marker_{{ loop.index }},
                        map,
                        shouldFocus: true
                    });
                    infowindows[{{ loop.index }}] = infowindow_{{ loop.index }};
                });
                markers.push(marker_{{ loop.index }});
                infowindow_{{ loop.index }}.addListener('closeclick', () => {
                    delete(infowindows[{{ loop.index }}]);
                });
                {% endfor -%}

                if ((window.location.hash.substr(1)) && (markers[window.location.hash.substr(1)])) {
                    markerOpen(window.location.hash.substr(1));
                };

                if (markers.length == 2) {
                    markerOpen(1);
                };
            };

            function markerOpen(id) {
                google.maps.event.trigger(markers[id], 'click');
            };

        </script>
    </head>
    <body onload="initMap()">
        <div id="leftbox">
            <h1><a href='/'>Eric's Seizures</a></h1>
            <div id="timespans">
                {% for timespan in timespans %}
                    {% if when != timespan %}<a href="{{ url_for('view', when=timespan) }}">{% endif %}{{ timespan }}{% if when != timespan %}</a>{% endif %}
                {% endfor %}
            </div>
            <br><hr>
            <div id="map_canvas"></div>
        </div>
        <div id="rightbox">
            <div id="raw">
                    <h2>{{ total_points }} seizure{% if total_points != 1 %}s{% endif %}</h2>
                    {% if total_points > 1 and points[-1] is defined and points[-1]['time'] is defined %}
                    <h4>since {{ points[-1]['time'] | format_datetime }}</h4>
                    {% endif %}
                <ol>
                {% for point in points %}
                    <li id="{{ loop.index }}"><a title="{{ point['address'] }} ({{ point['time']}})" href="#{{ loop.index }}" onclick="markerOpen({{ loop.index }});">{{ point['time'] | string | format_datetime }}</a></li>
                {% endfor -%}
                </ol>
            </div>
        </div>
    </body>
</html>
