{% extends "layout.html" %}
{% load static %}
{% block head %}
    {{ block.super }}
{% endblock head %}
{% block main %}
            <div class="card-group">

                <nav class="card-deck">
                    <div class="card rounded" id="seizures-card" style="height: 90vh; max-height: 90vh;">
                        <div class="card-header">
                            <div style="word-spacing: 0.25em;">
                                <a href="javascript:searchSeizures(1)">1h</a>
                                <a href="javascript:searchSeizures(6)">6h</a>
                                <a href="javascript:searchSeizures(12)">12h</a>
                                <a href="javascript:searchSeizures(24)">1d</a>
                                <a href="javascript:searchSeizures(168)">1w</a>
                                <a href="javascript:searchSeizures(720)">30d</a>
                                <a href="javascript:searchSeizures(4380)">6m</a>
                                <a href="javascript:searchSeizures(8760)">1y</a>
                            </div>
                            <form method="post" id="search-form" action="{% url "chart" %}">
                                {{ form.as_div }}
                                {% csrf_token %}
                                <button type="submit" class="m-1 btn btn-outline-primary rounded">Search</button>
                                <button type="reset" class="m-1 btn btn-outline-secondary rounded">Clear</button>
                            {% if perms.seizures.add_seizures %}
                                <button type="button" class="m-1 btn btn-outline-primary rounded" onClick="prepareSeizure('{{ csrf_token }}')">
                                    <span class="bi bi-plus-lg" id="add-span"></span>
                                </button>
                            {% endif %}
                            </form>
                            <div class="card-text text-center">
                                <a class="btn btn-outline-primary bi bi-calendar" href="{% url "calendar" %}" title="Calendar"></a>
                                <a class="btn btn-secondary bi bi-graph-up-arrow disabled" href="{% url "chart" %}" title="Chart"></a>
                                <a class="btn btn-outline-primary bi bi-geo-alt" href="{% url "map" %}" title="Map"></a>
                                <a class="btn btn-outline-primary bi bi-table" href="{% url "table" %}" title="Table"></a>
                            </div>
                        </div>
                    </div>
                </nav>

                <div class="card rounded" id="chart-card" style="height: 90vh; max-height: 90vh;">
                    <div class="card-body">
                        <div id="seizureChart" style="height: 100%; width: 100%;">
                        </div>
                    </div>
    {% block footer %}
        {{ block.super }}
    {% endblock footer %}
                </div>
            </div>
{% endblock main %}
{% block scripts %}
    {{ block.super }}
    <script src="{% static 'highcharts/highcharts.js' %}"></script>
    <script src="{% static 'highcharts/exporting.js' %}"></script>
    <script src="{% static 'highcharts/offline-exporting.js' %}"></script>
    <script src="{% static 'highcharts/export-data.js' %}"></script>
    <script src="{% static 'highcharts/accessibility.js' %}"></script>
    <script src="{% static 'chartSeizure.js' %}"></script>
    <script>

        function showTooltip(tooltipMillis) {
            const tooltipDT = DateTime.fromMillis(Number(tooltipMillis.split("#")[1])).toISODate()
            const tooltipItem = seizureChart.get("chart_point_" + tooltipDT)
            // console.log(tooltipItem)
            /* TODO: Figure out how to actually open the Highcharts tooltip. */
        }

        // Start with empty lists.
        const seizureList = document.createElement("ul")
        seizureList.classList.add("overflow-scroll")
        seizureList.classList.add("p-0")
        const seizures = []

        // Parse JSON containing device icons.
        const deviceIcons = JSON.parse(document.getElementById("device-icons").textContent)

        // Sub-header card text.
        const subHeadText = "Showing {{ start|timesince:end }}."
        const cardHeader = document.createElement("h6")
        cardHeader.classList.add("card-header")
        cardHeader.classList.add("text-secondary")
        cardHeader.classList.add("text-center")
        cardHeader.title = subHeadText
        cardHeader.appendChild(document.createTextNode(subHeadText))
        const seizuresCard = document.getElementById("seizures-card")
        seizuresCard.appendChild(cardHeader)

        // Parse and table JSON data containing seizures.
        const seizureJSON = document.getElementById("seizures").textContent
        const seizureData = Object.values(JSON.parse(JSON.parse(seizureJSON)))

        // Loop through seizures, storing count per day.
        let chartData = []
        for (const seizure of seizureData) {
            let chartedSeizure = chartSeizure(seizure)
            seizures.push(chartedSeizure)
            let seizureDT = DateTime.fromMillis(chartedSeizure.id).setZone(timeZone)
            let seizureDate = seizureDT.toISODate()
            if (!chartData[seizureDate]) {
                chartData[seizureDate] = 0
            }
            chartData[seizureDate] += 1
        }

        // Loop from start to end date, and chart the count of seizures each day.
        const chartStart = DateTime.fromISO(document.getElementById("start").innerText.replace(/"/g, "").replace(/'/g, ""))
        const chartStartDate = chartStart.toISODate()
        const chartEnd = DateTime.fromISO(document.getElementById("end").innerText.replace(/"/g, "").replace(/'/g, ""))
        const chartEndDate = chartEnd.toISODate()
        const chartInterval = Interval.fromDateTimes(chartStart, chartEnd)
        const chartDays = chartInterval.splitBy({ days: 1 }).map((d) => d.start)
        const chartSeizures = []
        for (const chartDay of chartDays) {
            let seizureDay = chartDay.toISODate()
            let seizureCount = chartData[seizureDay]
            if (!seizureCount) {
                seizureCount = 0
            }
            chartSeizures.push({
                x: seizureDay,
                y: seizureCount,
                id: "chart_point_" + seizureDay,
            })
        }

        // Append the list of seizure links to the navigation card.
        seizuresCard.appendChild(seizureList)

        // Add a card footer of the seizure count.
        const seizureCount = seizures.length
        const cardFooter = document.createElement("h5")
        cardFooter.classList.add("card-footer")
        cardFooter.classList.add("text-secondary")
        cardFooter.classList.add("text-center")
        let countText = `${seizureCount.toLocaleString("en-US")} seizure`
        if (seizureCount > 1) { countText += "s" }
        document.title += ` ${countText}`
        cardFooter.appendChild(document.createTextNode(countText))
        cardFooter.title = countText
        seizuresCard.appendChild(cardFooter)

        // Create the chart (using Highcharts).
        const seizureChart = new Highcharts.Chart({
            legend: {
                enabled: false,
            },
            title: {
                style: {
                    color: "#f8f9fa"
                },
                text: "Seizures",
            },
            chart: {
                backgroundColor: "#424242",
                renderTo: "seizureChart",
                zooming: {
                    type: "x"
                },
            },
            credits: false,
            plotOptions: {
                series: {
                    connectNulls: false,
                },
            },
            xAxis: {
                title: {
                    text: "Date",
                },
                type: "datetime",
                accessibility: {
                    description: "Date",
                },
                labels: {
                    style: {
                        color: "#f8f9fa",
                    },
                },
            },
            yAxis: {
                min: 0,
                title: {
                    text: "Seizures",
                },
                accessibility: {
                    description: "Count of seizures",
                },
                labels: {
                    style: {
                        color: "#f8f9fa",
                    },
                },
            },
            series: [
                {
                    color: "#2caffe",
                    type: "area",
                    name: "Seizures",
                    data: chartSeizures,
                },
            ],
            styledMode: true,
            subtitle: {
                text: "Number per day",
                style: { color: "#f8f9fa" },
            },
            time: {
                timezone: timeZone,
            },
            tooltip: {
                backgroundColor: "#424242",
                style: {
                    color: "#f8f9fa",
                }
            }
        })

        // Update the link to each seizure to open chart tooltips.
        for (const seizureLink of document.getElementsByClassName("seizure-link")) {
            seizureLink.onclick = async function () {
                showTooltip(seizureLink.hash)
            }
        }

    </script>
{% endblock scripts %}
