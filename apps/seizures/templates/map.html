{% extends "layout.html" %}
{% load static %}
{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}">
    <style>.leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #666; }</style>
{% endblock head %}
{% block main %}
            <div class="card-group">

                <nav class="card-deck">
                    <div class="card rounded" id="seizures-card" style="height: 90vh; max-height: 90vh;">
                        <div class="card-header">
                            <div style="word-spacing: 0.25em;">
                                <a href="javascript:searchSeizures(1)">1h</a>
                                <a href="javascript:searchSeizures(6)">6h</a>
                                <a href="javascript:searchSeizures(12)">12h</a>
                                <a href="javascript:searchSeizures(24)">1d</a>
                                <a href="javascript:searchSeizures(168)">1w</a>
                                <a href="javascript:searchSeizures(720)">30d</a>
                                <a href="javascript:searchSeizures(4380)">6m</a>
                                <a href="javascript:searchSeizures(8760)">1y</a>
                            </div>
                            <form method="post" id="search-form" action="{% url "map" %}">
                                {{ form.as_div }}
                                {% csrf_token %}
                                <button type="submit" class="m-1 btn btn-outline-primary rounded">Search</button>
                                <button type="reset" class="m-1 btn btn-outline-secondary rounded">Clear</button>
                            {% if perms.seizures.add_seizures %}
                                <button type="button" class="m-1 btn btn-outline-primary rounded" onClick="prepareSeizure('{{ csrf_token }}');">
                                    <span class="bi bi-plus-lg" id="add-span"></span>
                                </button>
                            {% endif %}
                            </form>
                            <div class="card-text text-center">
                                <a class="btn btn-outline-primary bi bi-calendar" href="{% url "calendar" %}" title="Calendar"></a>
                                <a class="btn btn-outline-primary bi bi-graph-up-arrow" href="{% url "chart" %}" title="Chart"></a>
                                <a class="btn btn-secondary bi bi-geo-alt disabled" href="#" title="Map"></a>
                                <a class="btn btn-outline-primary bi bi-table" href="{% url "table" %}" title="Table"></a>
                            </div>
                        </div>
                    </div>
                </nav>

                <div class="card rounded" id="map-card" style="height: 90vh; max-height: 90vh;">
                    <div class="card-body">
                        <div id="map-canvas" style="height: 100%; width: 100%;"></div>
                    </div>
    {% block footer %}
        {{ block.super }}
    {% endblock footer %}
                </div>
            </div>
{% endblock main %}
{% block scripts %}
    {{ block.super }}
    <script src="{% static 'leaflet/leaflet.js' %}"></script>
    <script src="{% static 'mapSeizure.js' %}"></script>
    <script src="{% static 'mapSeizures.js' %}"></script>
    <script>
        // Create the map (using Leaflet).
        const map = L.map("map-canvas")
        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap",
            className: "map-tiles"
        }).addTo(map)

        // Start with empty list, markers, latitudes, and longitudes.
        const seizureList = document.createElement("ul")
        seizureList.classList.add("overflow-scroll")
        seizureList.classList.add("p-0")
        const markers = []
        const latitudes = []
        const longitudes = []

        // Parse JSON containing device icons.
        const deviceIcons = JSON.parse(document.getElementById("device-icons").textContent)

        // Sub-header card text.
        const subHeadText = "Showing {{ start|timesince:end }}."
        const cardHeader = document.createElement("h6")
        cardHeader.classList.add("card-header")
        cardHeader.classList.add("text-secondary")
        cardHeader.classList.add("text-center")
        cardHeader.title = subHeadText
        cardHeader.appendChild(document.createTextNode(subHeadText))
        const seizuresCard = document.getElementById("seizures-card")
        seizuresCard.appendChild(cardHeader)

        mapSeizures(document.getElementById("seizures").textContent)
    </script>
{% endblock scripts %}
